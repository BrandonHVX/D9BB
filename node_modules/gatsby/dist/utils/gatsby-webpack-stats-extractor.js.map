{"version":3,"file":"gatsby-webpack-stats-extractor.js","names":["GatsbyWebpackStatsExtractor","constructor","publicPath","plugin","name","apply","compiler","previousChunkMapJson","previousWebpackStatsJson","hooks","done","tapAsync","stats","assets","assetsMap","childAssets","chunkGroup","compilation","chunkGroups","files","chunk","chunks","chunkReason","PARTIAL_HYDRATION_CHUNK_REASON","push","filter","f","slice","length","map","filename","rel","childChunkGroups","Object","entries","getChildrenByOrders","moduleGraph","chunkGraph","childFiles","childChunkGroup","webpackStats","toJson","all","assetsByChunkName","childAssetsByChunkName","newChunkMapJson","JSON","stringify","fs","writeFile","path","join","process","env","GATSBY_SLICES","scriptChunkMapping","chunkSliceContents","ensureDir","hashSliceContents","hash","assetSliceContents","polyfill","asset","endsWith","app","scriptsSliceHtmlChanged","ensureFileContent","store","dispatch","type","newWebpackStatsJson"],"sources":["../../src/utils/gatsby-webpack-stats-extractor.ts"],"sourcesContent":["import fs from \"fs-extra\"\nimport path from \"path\"\nimport { Compiler } from \"webpack\"\nimport { PARTIAL_HYDRATION_CHUNK_REASON } from \"./webpack/plugins/partial-hydration\"\nimport { store } from \"../redux\"\nimport { ensureFileContent } from \"./ensure-file-content\"\n\nexport class GatsbyWebpackStatsExtractor {\n  private plugin: { name: string }\n  private publicPath: string\n\n  constructor(publicPath: string) {\n    this.plugin = { name: `GatsbyWebpackStatsExtractor` }\n    this.publicPath = publicPath\n  }\n  apply(compiler: Compiler): void {\n    let previousChunkMapJson: string | undefined\n    let previousWebpackStatsJson: string | undefined\n    compiler.hooks.done.tapAsync(this.plugin.name, async (stats, done) => {\n      const assets: { [key: string]: Array<string> } = {}\n      const assetsMap = {}\n      const childAssets = {}\n      for (const chunkGroup of stats.compilation.chunkGroups) {\n        if (chunkGroup.name) {\n          const files: Array<string> = []\n          for (const chunk of chunkGroup.chunks) {\n            if (chunk.chunkReason !== PARTIAL_HYDRATION_CHUNK_REASON) {\n              files.push(...chunk.files)\n            }\n          }\n          assets[chunkGroup.name] = files.filter(f => f.slice(-4) !== `.map`)\n          assetsMap[chunkGroup.name] = files\n            .filter(\n              f =>\n                f.slice(-4) !== `.map` &&\n                f.slice(0, chunkGroup.name?.length) === chunkGroup.name\n            )\n            .map(filename => `/${filename}`)\n\n          for (const [rel, childChunkGroups] of Object.entries(\n            chunkGroup.getChildrenByOrders(\n              stats.compilation.moduleGraph,\n              stats.compilation.chunkGraph\n            )\n          )) {\n            if (!(chunkGroup.name in childAssets)) {\n              childAssets[chunkGroup.name] = {}\n            }\n\n            const childFiles: Array<string> = []\n            for (const childChunkGroup of childChunkGroups) {\n              for (const chunk of childChunkGroup.chunks) {\n                childFiles.push(...chunk.files)\n              }\n            }\n\n            childAssets[chunkGroup.name][rel] = childFiles\n          }\n        }\n      }\n\n      const webpackStats = {\n        ...stats.toJson({ all: false, chunkGroups: true }),\n        assetsByChunkName: assets,\n        childAssetsByChunkName: childAssets,\n      }\n\n      const newChunkMapJson = JSON.stringify(assetsMap)\n      if (newChunkMapJson !== previousChunkMapJson) {\n        await fs.writeFile(\n          path.join(`public`, `chunk-map.json`),\n          newChunkMapJson\n        )\n\n        if (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES) {\n          // Add chunk mapping metadata to scripts slice\n          const scriptChunkMapping = `window.___chunkMapping=${JSON.stringify(\n            newChunkMapJson\n          )};`\n\n          const chunkSliceContents = `\n          <script\n            id=\"gatsby-chunk-mapping\"\n          >\n            ${scriptChunkMapping}\n          </script>\n        `\n\n          await fs.ensureDir(path.join(`public`, `_gatsby`, `slices`))\n\n          const hashSliceContents = `<script>window.___webpackCompilationHash=\"${stats.hash}\";</script>`\n\n          const assetSliceContents: Array<string> = []\n\n          if (`polyfill` in assets && assets.polyfill) {\n            for (const asset of assets.polyfill) {\n              if (asset.endsWith(`.js`)) {\n                assetSliceContents.push(\n                  `<script src=\"${this.publicPath}/${asset}\" nomodule></script>`\n                )\n              }\n            }\n          }\n\n          if (`app` in assets && assets.app) {\n            for (const asset of assets.app) {\n              if (asset.endsWith(`.js`)) {\n                assetSliceContents.push(\n                  `<script src=\"${this.publicPath}/${asset}\" async></script>`\n                )\n              }\n            }\n          }\n\n          const scriptsSliceHtmlChanged = await ensureFileContent(\n            path.join(`public`, `_gatsby`, `slices`, `_gatsby-scripts-1.html`),\n            chunkSliceContents + hashSliceContents + assetSliceContents.join(``)\n          )\n\n          if (scriptsSliceHtmlChanged) {\n            store.dispatch({\n              type: `SLICES_SCRIPTS_REGENERATED`,\n            })\n          }\n        }\n\n        previousChunkMapJson = newChunkMapJson\n      }\n\n      const newWebpackStatsJson = JSON.stringify(webpackStats)\n      if (newWebpackStatsJson !== previousWebpackStatsJson) {\n        await fs.writeFile(\n          path.join(`public`, `webpack.stats.json`),\n          newWebpackStatsJson\n        )\n        previousWebpackStatsJson = newWebpackStatsJson\n      }\n\n      done()\n    })\n  }\n}\n"],"mappings":"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"}