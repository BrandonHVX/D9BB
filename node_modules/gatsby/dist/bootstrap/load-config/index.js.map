{"version":3,"file":"index.js","names":["loadConfig","siteDirectory","processFlags","configModule","configFilePath","getConfigFile","config","preferDefault","reporter","panic","id","context","configName","enabledConfigFlags","unknownFlagMessage","unfitFlagMessage","message","handleFlags","availableFlags","flags","warn","forEach","flag","process","env","info","GATSBY_PARTIAL_HYDRATION","GATSBY_SLICES","telemetryId","telemetry","trackFeatureIsUsed","plugins","loadThemes","rootDir","store","dispatch","internalActions","setSiteConfig"],"sources":["../../../src/bootstrap/load-config/index.ts"],"sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport telemetry from \"gatsby-telemetry\"\nimport { preferDefault } from \"../prefer-default\"\nimport { getConfigFile } from \"../get-config-file\"\nimport { internalActions } from \"../../redux/actions\"\nimport loadThemes from \"../load-themes\"\nimport { store } from \"../../redux\"\nimport handleFlags from \"../../utils/handle-flags\"\nimport availableFlags from \"../../utils/flags\"\nimport { IProgram } from \"../../commands/types\"\nimport { IGatsbyConfig } from \"../../internal\"\n\nexport async function loadConfig({\n  siteDirectory,\n  processFlags = false,\n}: {\n  siteDirectory: string\n  processFlags?: boolean\n  program?: IProgram\n}): Promise<IGatsbyConfig> {\n  // Try opening the site's gatsby-config.js file.\n  const { configModule, configFilePath } = await getConfigFile(\n    siteDirectory,\n    `gatsby-config`\n  )\n  let config = preferDefault(configModule)\n\n  // The root config cannot be exported as a function, only theme configs\n  if (typeof config === `function`) {\n    reporter.panic({\n      id: `10126`,\n      context: {\n        configName: `gatsby-config`,\n        siteDirectory,\n      },\n    })\n  }\n\n  if (config && processFlags) {\n    // Setup flags\n    if (config) {\n      // Get flags\n      const {\n        enabledConfigFlags,\n        unknownFlagMessage,\n        unfitFlagMessage,\n        message,\n      } = handleFlags(availableFlags, config.flags)\n\n      if (unknownFlagMessage !== ``) {\n        reporter.warn(unknownFlagMessage)\n      }\n      if (unfitFlagMessage !== ``) {\n        reporter.warn(unfitFlagMessage)\n      }\n      //  set process.env for each flag\n      enabledConfigFlags.forEach(flag => {\n        process.env[flag.env] = `true`\n      })\n\n      // Print out message.\n      if (message !== ``) {\n        reporter.info(message)\n      }\n\n      if (process.env.GATSBY_PARTIAL_HYDRATION) {\n        delete process.env.GATSBY_SLICES\n\n        reporter.warn(`SLICES is inactive when PARTIAL_HYDRATION is enabled.`)\n      } else {\n        process.env.GATSBY_SLICES = `true`\n      }\n\n      //  track usage of feature\n      enabledConfigFlags.forEach(flag => {\n        if (flag.telemetryId) {\n          telemetry.trackFeatureIsUsed(flag.telemetryId)\n        }\n      })\n\n      // Track the usage of config.flags\n      if (config.flags) {\n        telemetry.trackFeatureIsUsed(`ConfigFlags`)\n      }\n    }\n  }\n\n  // theme gatsby configs can be functions or objects\n  if (config) {\n    const plugins = await loadThemes(config, {\n      configFilePath,\n      rootDir: siteDirectory,\n    })\n    config = plugins.config\n  }\n\n  store.dispatch(internalActions.setSiteConfig(config))\n\n  return config\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAIO,eAAeA,UAAf,CAA0B;EAC/BC,aAD+B;EAE/BC,YAAY,GAAG;AAFgB,CAA1B,EAOoB;EACzB;EACA,MAAM;IAAEC,YAAF;IAAgBC;EAAhB,IAAmC,MAAM,IAAAC,4BAAA,EAC7CJ,aAD6C,EAE5C,eAF4C,CAA/C;EAIA,IAAIK,MAAM,GAAG,IAAAC,4BAAA,EAAcJ,YAAd,CAAb,CANyB,CAQzB;;EACA,IAAI,OAAOG,MAAP,KAAmB,UAAvB,EAAkC;IAChCE,iBAAA,CAASC,KAAT,CAAe;MACbC,EAAE,EAAG,OADQ;MAEbC,OAAO,EAAE;QACPC,UAAU,EAAG,eADN;QAEPX;MAFO;IAFI,CAAf;EAOD;;EAED,IAAIK,MAAM,IAAIJ,YAAd,EAA4B;IAC1B;IACA,IAAII,MAAJ,EAAY;MACV;MACA,MAAM;QACJO,kBADI;QAEJC,kBAFI;QAGJC,gBAHI;QAIJC;MAJI,IAKF,IAAAC,oBAAA,EAAYC,cAAZ,EAA4BZ,MAAM,CAACa,KAAnC,CALJ;;MAOA,IAAIL,kBAAkB,KAAM,EAA5B,EAA+B;QAC7BN,iBAAA,CAASY,IAAT,CAAcN,kBAAd;MACD;;MACD,IAAIC,gBAAgB,KAAM,EAA1B,EAA6B;QAC3BP,iBAAA,CAASY,IAAT,CAAcL,gBAAd;MACD,CAdS,CAeV;;;MACAF,kBAAkB,CAACQ,OAAnB,CAA2BC,IAAI,IAAI;QACjCC,OAAO,CAACC,GAAR,CAAYF,IAAI,CAACE,GAAjB,IAAyB,MAAzB;MACD,CAFD,EAhBU,CAoBV;;MACA,IAAIR,OAAO,KAAM,EAAjB,EAAoB;QAClBR,iBAAA,CAASiB,IAAT,CAAcT,OAAd;MACD;;MAED,IAAIO,OAAO,CAACC,GAAR,CAAYE,wBAAhB,EAA0C;QACxC,OAAOH,OAAO,CAACC,GAAR,CAAYG,aAAnB;;QAEAnB,iBAAA,CAASY,IAAT,CAAe,uDAAf;MACD,CAJD,MAIO;QACLG,OAAO,CAACC,GAAR,CAAYG,aAAZ,GAA6B,MAA7B;MACD,CA/BS,CAiCV;;;MACAd,kBAAkB,CAACQ,OAAnB,CAA2BC,IAAI,IAAI;QACjC,IAAIA,IAAI,CAACM,WAAT,EAAsB;UACpBC,wBAAA,CAAUC,kBAAV,CAA6BR,IAAI,CAACM,WAAlC;QACD;MACF,CAJD,EAlCU,CAwCV;;MACA,IAAItB,MAAM,CAACa,KAAX,EAAkB;QAChBU,wBAAA,CAAUC,kBAAV,CAA8B,aAA9B;MACD;IACF;EACF,CAlEwB,CAoEzB;;;EACA,IAAIxB,MAAJ,EAAY;IACV,MAAMyB,OAAO,GAAG,MAAM,IAAAC,mBAAA,EAAW1B,MAAX,EAAmB;MACvCF,cADuC;MAEvC6B,OAAO,EAAEhC;IAF8B,CAAnB,CAAtB;IAIAK,MAAM,GAAGyB,OAAO,CAACzB,MAAjB;EACD;;EAED4B,YAAA,CAAMC,QAAN,CAAeC,wBAAA,CAAgBC,aAAhB,CAA8B/B,MAA9B,CAAf;;EAEA,OAAOA,MAAP;AACD"}